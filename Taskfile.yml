# https://taskfile.dev

version: '3'

vars:
  GIT_BRANCH:
    sh: git rev-parse --abbrev-ref HEAD
  GIT_COMMIT:
    sh: git log -n 1 --format=%h

tasks:
  default:
    cmds:
      - task: run

  deps:
    cmds:
      - go mod vendor

  build:
    cmds:
      - task: build:dev

  build:dev:
    cmds:
      - |
        go build --mod=vendor -ldflags="-s -w 
            -X github.com/endorama/devid/internal/version.version={{.VERSION}} 
            -X github.com/endorama/devid/internal/version.commit={{.GIT_COMMIT}}{{.GIT_DIRTY}}"
    vars:
      VERSION: "{{.GIT_BRANCH}}"
      GIT_DIRTY:
        sh: "[[ -z $(git status --porcelain) ]] || echo '-dirty'"

  lint:
    cmds:
      - golangci-lint run

  run:
    desc: Build and run the web app
    cmds:
      - task: build
      - ./devid{{.EXE}}

  tests:
    desc: Run entire testsuite
    cmds:
      - go test ./...

  tests:single:
    desc: Run a single test, specify with RUN
    cmds:
      - go test -v ./... -run {{.RUN}}

